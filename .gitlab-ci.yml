# Simple GitLab CI/CD Pipeline

stages:
  - lint
  - test
  - build
  - deploy

# Define variables
variables:
  DOCKER_IMAGE: python:3.9

# Pylint Stage
pylint_job:
  stage: lint
  image: python:3.9
  script:
    - echo "Running pylint..."
    - pip install -r requirements.txt
    - pip install pylint
    - pylint math.py
  only:
    - merge_requests
    - main
  allow_failure: false

# Black Stage
black_job:
  stage: lint
  image: python:3.9
  script:
    - echo "Running black..."
    - pip install black
    - black --check --diff math.py tests/
  only:
    - merge_requests
    - main
  allow_failure: false

# MyPy Stage
mypy_job:
  stage: lint
  image: python:3.9
  script:
    - echo "Running mypy..."
    - pip install mypy
    - mypy math.py
  only:
    - merge_requests
    - main
  allow_failure: false

# Test Stage
test_job:
  stage: test
  image: python:3.9
  script:
    - echo "Running tests..."
    - pip install -r requirements.txt
    - pip install pytest pytest-cov
    - pytest tests/ -v --cov=.
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
  only:
    - merge_requests
    - main
  allow_failure: false

# Build Stage
build_job:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Building Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
  only:
    - main
  when: on_success

# Deploy Stage (Example)
deploy_job:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying application..."
    - echo "Deployment successful!"
  environment:
    name: production
    url: https://example.com
  only:
    - main
  when: on_success

# Manual deployment
deploy_manual:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Manual deployment started..."
    - echo "Application deployed!"
  when: manual
  only:
    - main