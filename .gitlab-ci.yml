# GitLab CD (Continuous Deployment) Pipeline - Nimbus DEV Cluster

stages:
  - deploy
  - health_check
  - rollback

variables:
  DOCKER_REGISTRY: $CI_REGISTRY
  DOCKER_REGISTRY_USER: $CI_REGISTRY_USER
  DOCKER_REGISTRY_PASSWORD: $CI_REGISTRY_PASSWORD
  KUBECONFIG: /tmp/kubeconfig
  APP_NAMESPACE: myrtus-gitlab
  APP_DEPLOYMENT: math-app-deployment
  APP_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  CLUSTER_NAME: "nimbus"
  CLUSTER_SERVER: "https://rancher.hiro-develop.nl/k8s/clusters/c-m-smpdn56q"
  KUBE_USER: "nimbus"

# Deploy to Nimbus DEV Cluster
deploy_dev:
  stage: deploy
  image: ubuntu:latest
  before_script:
    - apt-get update -y
    - apt-get install -y curl
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
  script:
    - echo "Deploying to Nimbus DEV cluster..."

    # Create kubeconfig file
    - mkdir -p ~/.kube
    - |
      cat > $KUBECONFIG <<EOF
      apiVersion: v1
      kind: Config
      clusters:
      - name: "nimbus"
        cluster:
          server: "$CLUSTER_SERVER"
      users:
      - name: "nimbus"
        user:
          token: "$KUBE_TOKEN"
      contexts:
      - name: "nimbus"
        context:
          user: "nimbus"
          cluster: "nimbus"
      current-context: "nimbus"
      EOF

    # Verify cluster connection
    - kubectl cluster-info
    - kubectl get nodes

    # Create namespace if it doesn't exist
    - kubectl create namespace $APP_NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

    # Create Docker registry secret for pulling images
    - |
      kubectl create secret docker-registry regcred \
        --docker-server=$CI_REGISTRY \
        --docker-username=$DOCKER_REGISTRY_USER \
        --docker-password=$DOCKER_REGISTRY_PASSWORD \
        --docker-email=$CI_PROJECT_USER_LOGIN@example.com \
        -n $APP_NAMESPACE \
        --dry-run=client -o yaml | kubectl apply -f -

    # Apply Kubernetes manifests
    - echo "Applying Kubernetes manifests..."
    - kubectl apply -f k8s/ -n $APP_NAMESPACE
    
    # Update deployment image to current commit
    - echo "Updating deployment image to $APP_IMAGE..."
    - |
      kubectl set image deployment/$APP_DEPLOYMENT \
        math-app=$APP_IMAGE \
        -n $APP_NAMESPACE \
        --record

    # Wait for rollout
    - kubectl rollout status deployment/$APP_DEPLOYMENT -n $APP_NAMESPACE --timeout=5m

    # Show deployment status
    - kubectl describe deployment $APP_DEPLOYMENT -n $APP_NAMESPACE
    - kubectl get pods -n $APP_NAMESPACE

    - echo "Deployment to Nimbus DEV cluster successful!"
  environment:
    name: dev
    url: https://rancher.hiro-develop.nl
    kubernetes:
      namespace: $APP_NAMESPACE
  only:
    - main
  when: on_success
  allow_failure: false

# Health Check on Nimbus DEV
health_check_dev:
  stage: health_check
  image: ubuntu:latest
  before_script:
    - apt-get update -y
    - apt-get install -y curl
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
  script:
    - echo "Running health checks on Nimbus DEV cluster..."
    
    # Create kubeconfig file
    - |
      mkdir -p ~/.kube
      cat > $KUBECONFIG <<EOF
      apiVersion: v1
      kind: Config
      clusters:
      - name: "nimbus"
        cluster:
          server: "$CLUSTER_SERVER"
      users:
      - name: "nimbus"
        user:
          token: "$KUBE_TOKEN"
      contexts:
      - name: "nimbus"
        context:
          user: "nimbus"
          cluster: "nimbus"
      current-context: "nimbus"
      EOF
    
    # Check if pods are running
    - kubectl get pods -n $APP_NAMESPACE -l app=math-app
    - kubectl describe pods -n $APP_NAMESPACE -l app=math-app
    - kubectl logs -n $APP_NAMESPACE -l app=math-app --tail=10
    
    - echo "Nimbus DEV health check passed!"
  only:
    - main
  when: on_success
  allow_failure: true

# Rollback Nimbus DEV Cluster (Manual)
rollback_dev:
  stage: rollback
  image: ubuntu:latest
  before_script:
    - apt-get update -y
    - apt-get install -y curl
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
  script:
    - echo "Rolling back Nimbus DEV cluster to previous version..."

    # Create kubeconfig file
    - |
      mkdir -p ~/.kube
      cat > $KUBECONFIG <<EOF
      apiVersion: v1
      kind: Config
      clusters:
      - name: "nimbus"
        cluster:
          server: "$CLUSTER_SERVER"
      users:
      - name: "nimbus"
        user:
          token: "$KUBE_TOKEN"
      contexts:
      - name: "nimbus"
        context:
          user: "nimbus"
          cluster: "nimbus"
      current-context: "nimbus"
      EOF

    # Rollback deployment
    - kubectl rollout undo deployment/$APP_DEPLOYMENT -n $APP_NAMESPACE

    # Wait for rollback
    - kubectl rollout status deployment/$APP_DEPLOYMENT -n $APP_NAMESPACE --timeout=5m

    # Show deployment status
    - kubectl describe deployment $APP_DEPLOYMENT -n $APP_NAMESPACE
    - kubectl get pods -n $APP_NAMESPACE

    - echo "Rollback completed!"
  environment:
    name: dev
    action: stop
  only:
    - main
  when: manual
  allow_failure: false

# View Deployment Logs
view_logs:
  stage: health_check
  image: ubuntu:latest
  before_script:
    - apt-get update -y
    - apt-get install -y curl
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
  script:
    - echo "Viewing deployment logs..."

    # Create kubeconfig file
    - |
      mkdir -p ~/.kube
      cat > $KUBECONFIG <<EOF
      apiVersion: v1
      kind: Config
      clusters:
      - name: "nimbus"
        cluster:
          server: "$CLUSTER_SERVER"
      users:
      - name: "nimbus"
        user:
          token: "$KUBE_TOKEN"
      contexts:
      - name: "nimbus"
        context:
          user: "nimbus"
          cluster: "nimbus"
      current-context: "nimbus"
      EOF

    # Get logs from all pods
    - kubectl logs -n $APP_NAMESPACE -l app=math-app --tail=100

  only:
    - main
  when: manual
  allow_failure: true